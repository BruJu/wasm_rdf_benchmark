#!/usr/bin/env python3

import datetime
import os
import random
import subprocess
import sys

os.chdir(os.path.dirname(sys.argv[0]))

KINDS = {
    "fast"             : [ "rust", "rdfjsdataset"               ],
    "light"            : [ "rust", "rdfjsdataset"               ],
    "tree"             : [ "rust", "rdfjsdataset"               ],
    "tree_anti"        : [ "rust", "rdfjsdataset"               ],
    "full"             : [ "rust", "rdfjsdataset"               ],
    "array"            : [ "rust", "rdfjsdataset"               ],
    "fast_array"       : [ "rust", "rdfjsdataset"               ],
    "tree_array"       : [ "rust", "rdfjsdataset"               ],
    "full_array"       : [ "rust", "rdfjsdataset"               ],
    "wrap_tree"        : [         "rdfjsdataset"               ],
    "wrap_fast"        : [         "rdfjsdataset"               ],
    "wasm_tree"        : [         "rdfjsdataset", "rdfjsstore" ], # Identifier List, Shared Mapping
    "wasm_tree_FI"     : [         "rdfjsdataset"               ], # Always Forest  , Independant Mapping
    "wasm_tree_FS"     : [         "rdfjsdataset"               ], # Always Forest  , Shared Mapping
    "wasm_tree_II"     : [         "rdfjsdataset"               ], # Identifier List, Independant Mapping
    "graphy"           : [         "rdfjsdataset"               ],
    "n3"               : [                         "rdfjsstore" ]
}

TOOLS = {
    "rust"        : "./b_sophia/target/release/wasm_rdf_benchmark {task} '{filename}' {kind}",
    "rdfjsdataset": "./b_nodejs/benchDataset.js                   {task} '{filename}' {kind}",
    "rdfjsstore"  : "./b_nodejs/benchStore.js                     {task} '{filename}' {kind}"
}

FILES = [
    ("./data/persondata_en_10k.ttl",    10_000),
    ("./data/persondata_en_20k.ttl",    20_000),
    ("./data/persondata_en_40k.ttl",    40_000),
    ("./data/persondata_en_80k.ttl",    80_000),
    ("./data/persondata_en_100k.ttl",  100_000),
    ("./data/persondata_en_500k.ttl",  500_000),
    ("./data/persondata_en_1M.ttl",  1_000_000),
    # ("./data/persondata_en.ttl",    10_310_000),
]

HEADER = "t_load,m_graph,m_graph_end,t_first,t_rest,t_second,t_second_rest"

QUERIES = [ "S", "SG", "PO", "POG" ]

def individual():
    if len(sys.argv) != 6:
        print(sys.argv)
        print("usage: {} individual <NB_ITER> <task> <tool> <kind>".format(sys.argv[0]), file=sys.stderr)
        print("  available tasks: {}"   .format(",".join(QUERIES)))
        print("  available tools: {}"   .format(",".join(TOOLS)  ))
        print("  available datasets: {}".format(",".join(KINDS)  ))
        exit(1)
        
    args = sys.argv[3:]
    task = args[0]
    tool = args[1]
    kind = args[2]

    if task not in QUERIES:
        print(task)
        print("available tasks: " + ", ".join(QUERIES), file=sys.stderr)
        exit(2)
    if tool not in TOOLS:
        print("------" + tool)
        print("available tools: " + ", ".join(TOOLS), file=sys.stderr)
        exit(3)
    if kind not in KINDS:
        print("Invalid kind: " + kind)
        print("available kinds: " + ", ".join(KINDS), file=sys.stderr)
        exit(8)

    list_of_tasks = []

    for filename, size in FILES:
        t = (task, tool, kind, filename, size)
        list_of_tasks.append(t)
    
    return list_of_tasks

def run_benchmarks(list_of_tasks):
    # Shuffle
    random.shuffle(list_of_tasks)

    # Prepare output file
    csv = "csv/bench_{}.csv".format(
        str(datetime.datetime.now())[:19].replace(' ', '-').replace(':', '-'),
    )

    file_exists = os.path.isfile(csv)

    with open(csv, 'w+') as f:
        try:
            print("WRITING", csv, file=sys.stderr)
            if not file_exists:
                f.write("tool,dataset,pattern,size,{}\n".format(HEADER))
                f.flush()

            # Run every benchmark
            for task, tool, kind, filename, size in list_of_tasks:
                one_benchmark(f, task, tool, kind, filename, size)

        except KeyboardInterrupt:
            sys.stdout.write("\r") # clear the '^C' that appears

def one_benchmark(f, task, tool, kind, filename, size):
    cmd = TOOLS[tool]
    cmd = cmd.format(task=task, filename=filename, kind=kind)
    res = subprocess.run(cmd, shell=True, check=True, stdout=subprocess.PIPE, stderr=subprocess.DEVNULL)
    f.write("{},{},{},{},{}".format(tool, kind, task, size, res.stdout.decode('utf8')))
    f.flush()
    print("DONE", task, tool, kind, filename, file=sys.stderr)

# =============================================================================

def everything():
    list_of_tasks = []
    for task in QUERIES:
        for kind in KINDS:
            for filename, size in FILES:
                if "rust" in KINDS[kind]:
                    t = (task, "rust", kind, filename, size)
                    list_of_tasks.append(t)
                
                if "rdfjsdataset" in KINDS[kind]:
                    t = (task, "rdfjsdataset", kind, filename, size)
                    list_of_tasks.append(t)

    return list_of_tasks


def fast_dataset_exportation():
    list_of_tasks = []
    for task in QUERIES:
        for kind in ["fast", "fast_array", "wrap_fast"]:
            for filename, size in FILES:
                    if "rust" in KINDS[kind]:
                        t = (task, "rust", kind, filename, size)
                        list_of_tasks.append(t)
                    
                    if "rdfjsdataset" in KINDS[kind]:
                        t = (task, "rdfjsdataset", kind, filename, size)
                        list_of_tasks.append(t)

    return list_of_tasks

def wasm_tree_general():
    list_of_tasks = []
    
    for task in ["S", "POG"]:
        for filename, size in FILES:
            for kind in ["wasm_tree", "tree", "wrap_tree", "graphy"]:
                t = (task, "rdfjsdataset", kind, filename, size)
                list_of_tasks.append(t)
            
            for kind in ["wasm_tree", "n3"]:
                t = (task, "rdfjsstore", kind, filename, size)
                list_of_tasks.append(t)

    return list_of_tasks

def wasm_tree_ablation():
    list_of_tasks = []
    
    for task in ["S", "POG"]:
        for filename, size in [("./data/persondata_en_1M.ttl", 1_000_000)]:
            for kind in ["tree", "wasm_tree", "wrap_tree", "graphy", "wasm_tree_FI", "wasm_tree_FS", "wasm_tree_II"]:
                if "rdfjsdataset" in KINDS[kind]:
                    t = (task, "rdfjsdataset", kind, filename, size)
                    list_of_tasks.append(t)
    
    return list_of_tasks

def tree_variants():
    list_of_tasks = []

    for kind in ["tree", "tree_anti", "tree_array"]:
        for filename, size in FILES:
                if "rust" in KINDS[kind]:
                    t = ("POG", "rust", kind, filename, size)
                    list_of_tasks.append(t)

    return list_of_tasks

def wasm_tree_store_vs_dataset():
    list_of_tasks = []
    
    for filename, size in FILES:
            for kind in ["wasm_tree"]:
                t = ("POG", "rdfjsdataset", kind, filename, size)
                list_of_tasks.append(t)
                t = ("POG", "rdfjsstore", kind, filename, size)
                list_of_tasks.append(t)

    return list_of_tasks


if __name__ == "__main__":
    available_choices = {
        "individual"         : { "function": individual        , "description": "Evaluate one configuration" },
        "WasmTreeEvaluation" : { "function": wasm_tree_general , "description": "Evaluate TreeDataset and WasmTree on S and POG requests"},
        "WasmTreeAblation"   : { "function": wasm_tree_ablation, "description": "Evaluate TreeDataset and WasmTree as a dataset with some features missing" },
        "WasmTreeDatasetOrStore" : { "function": wasm_tree_store_vs_dataset, "description": "Run benchmarks for WasmTreeDataset and WasmTreeStore only"},
        # "VariantsOfTree"     : { "function": tree_variants, "description": "Compares the variants of TreeDataset in native Rust" },
        # "fast_dataset_exportation" : { "function": fast_dataset_exportation, "description": "Performances of FastDataset in native Rust compared with exportation in Javascript" },
        # "everything" : { "function" : everything, "description": "Everything which is not a store"}
    }

    if len(sys.argv) == 1 or sys.argv[1] not in available_choices:
        print(sys.argv)
        print("usage: {} [mode]".format(sys.argv[0]), file=sys.stderr)
        print("  available modes:")

        for available in available_choices:
            print("  - {}: {}".format(available, available_choices[available]["description"]))
        exit(1)

    if len(sys.argv) > 2:
        nb_iter = int(sys.argv[2])
    else:
        nb_iter = 1
    
    list_of_tasks = available_choices[sys.argv[1]]["function"]()

    # Multiply the number of tasks in list_of_task by nb_iter
    lot_len = len(list_of_tasks)
    for _ in range(nb_iter - 1):
        for i in range(lot_len):
            list_of_tasks.append(list_of_tasks[i])

    # Run the benchmark (the list_of_tasks will be shuffled)
    run_benchmarks(list_of_tasks)

